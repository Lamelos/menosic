{% load static %}
<html>
<head>
    <script src="//code.jquery.com/jquery-2.2.0.min.js"></script>

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">

    <!-- Optional theme -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css">

    <!-- Latest compiled and minified JavaScript -->
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

    <link rel="shortcut icon" type="image/png" href="{% static 'favicon.png' %}" />
<style>
#outer-container {
    position: relative;
    height: 100%;
    margin: 0;
}
#outer-content-container {
    margin: 0;
    padding-top: 30px;
    position: absolute;
    height: 100%;
    width: 100%;
    z-index: 10;
}
#header {
    margin: 0;
    width: 100%;
    position: absolute;
    height: 30px;
    background: #efefef;
    z-index: 20;
    border-bottom: 1px solid #ddd;
}
#header_left {
    float: left;
    padding: 4px;
}
#header_right {
    float: right;
    padding: 4px;
}
#header_left h1 {
    padding: 0;
    margin: 0px 4px;
    font-size: 20px;
    color: #b7337a;
}
#header_left h1 i{
    display: inline-block;
    padding-right: 10px;
}
input[type=text] {
    border: 1px solid #ccc;
    border-radius: 4px;
    padding: 0 3px;
}
#header label {
    margin-left: 5px;
    color: #337ab7;
}
.meta_overlay {
    background: #efefef;
    position: absolute;
    top: 0px;
    left: 0px;
    right: 0px;
    margin: 0;
    border: 1px solid #dfdfdf;
    padding: 5px 10px;
}
.clear {
    clear: both;
}
.table>tbody>tr>td,
.table>tbody>tr>th,
.table>tfoot>tr>td,
.table>tfoot>tr>th,
.table>thead>tr>td,
.table>thead>tr>th {
    font-size: 12px;
    padding: 3px;
}
.album {
    margin: 10px 0px;
}

.album-cover {
    float: right;
}

.album .album-cover img {
    width: 200px;
}

.last-played-item {
    margin: 0px 0px 20px 0px;
}

.last-played-info {
    float: left;
}

#last_played .album-cover img {
    width: 40px;
}

#registration {
    margin: 100px auto;
    max-width: 320px;
}
#registration h1 {
    margin: 0;
    padding: 0;
}
#registration form {
    padding: 15px;
    margin: 0;
}
#registration label{
    width: 100px;
    display: inline-block;
}

#artists { /* left sidebar */
    height: 100%;
    overflow-y: scroll;
    border-right: 1px solid #ddd;
}
#content-container { /* middle container */
    height: 100%;
    margin: 0;
    padding: 0;
}
#content { /* middle top */
    height: 60%;
    overflow-y: scroll;
}
#playlist-container { /* middle bottom */
    height: 40%;
    margin-top -1px;
    border-top: 1px solid #ddd;
    padding: 0;
    margin: 0;
}
#client-control {
    display: none;
    font-size: 20px;
    vertical-align: top;
    padding: 3px;
}
#player-selector {
    display: inline-block;
    font-size: 14px;
    vertical-align: top;
    padding: 6px;
}
#player-container {
    position: absolute;
    height: 30px;
    width: 100%;
    padding-right: 16px;
}
#playlist {
    overflow-y: scroll;
    height: 100%;
    padding-top: 45px;
}
#playlist #actions {
    min-width: 40px;
}
#meta { /* right sidebar */
    overflow-y: scroll;
    height: 100%;
    border-left: 1px solid #ddd;
}
#navigation {
    background: #efefef;
    width: 30px;
    height: 100%;
    font-size: 12px;
    text-align: center;
    padding: 10px 0px;
    margin-left: -15px;
}
#navigation li a {
    width: 100%;
    text-align: center;
    padding: 3px 0px;
    display: block;
}
#navigation li a:hover {
    background: #afafaf;
}
#navigation li.active > a {
    background: #aaaaaa;
    font-weight: 400;
}
@media (max-width: 767px) {
    #meta {
        display: none;
    }
}
.padding {
    padding: 15px;
}
.playing {
    font-weight: bold;
}
#artists-list {
    margin-left: 35px;
}
.bottom-buffer {
    margin-bottom: 5px;
}
.col-height-1 {
    height: 390px;
}
.col-height-1 img {
    max-height: 218px;
    max-width: inherit;
}
.new-album-item {
  display: block;
  float: left;
  text-transform: uppercase;
  width: 190px;
  height: 190px;
  overflow: hidden;
}

.new-album-item .thumbnail {
  width: 190px;
  height: 190px;
} 

.new-album-item .caption {
  position: relative;
  top: -100px;
  background-color: rgba(30, 30, 30, 0.3);
  margin: 0px 5px;
  padding: 1px 3px 0px;
  float: left;
  width: 180px;
}

.new-album-item .caption h3 {
  font-size: 14px;
  padding: 0px;
  margin: 0px;
  float: right;
  text-align: right;
}

.new-album-item .caption h4 {
  font-size: 11px;
  margin: 5px 0px 0px;
  float: right;
  text-align: right;
  clear: both;
}

.new-album-item .caption p {
  text-align: left;
  font-size: 10px;
  padding: 5px 0px 0px;
  float: left;
}

.new-album-item a {
  color: #efefef;
}

.new-album-item a:hover {
  color: #aaa;
}

/* colorize album types */
.albumtype-compilation a {
  color: #ab3;
}
.albumtype-single a {
  color: #3a3;
}
.albumtype-ep a {
  color: #3aa;
}
.albumtype-live a {
  color: #a3a;
}
.albumtype-soundtrack a {
  color: #a33;
}

</style>
<script>
var local_player = Math.random().toString(36).replace(/[^a-zA-Z0-9]+/g, '').substr(0, 10);
var control_player = local_player;
var playlist = {{ playlist.id }};
var ws;

var delay = (function(){
  var timer = 0;
  return function(callback, ms){
    clearTimeout (timer);
    timer = setTimeout(callback, ms);
  };
})();

function play_selected() {
    if (control_player == local_player) {
        var player = $('#player').get(0);
        player.pause();
        $('#player source#mp3').attr('src', $("#playlist .playing a.to_player").attr("mp3"));
        $('#player source#ogg').attr('src', $("#playlist .playing a.to_player").attr("ogg"));
        $('#player').attr('playlist_id', $('#playlist .playing').attr('id'));
        player.load();
        player.play();

        ws.send(JSON.stringify({
            action: "song_change",
            key: "{{ user.id }}",
            playlist, playlist,
            player: control_player,
            identifier: $('#playlist .playing').attr('id')
        }));
    } else {
        ws.send(JSON.stringify({
            action: "play_song",
            key: "{{ user.id }}",
            playlist, playlist,
            player: control_player,
            identifier: $('#playlist .playing').attr('id')
        }));
    }
}
function play_next() {
    current = $('#playlist .playing');
    if (current.get(0) != $('#playlist tr:last').get(0)) {
        current.next('tr').addClass('playing');
        current.removeClass('playing');
        play_selected();
    }
}

function link_to_player() {
    $('.playing').removeClass('playing');
    $(this).parent('td').parent('tr').addClass('playing');
    play_selected();
    setTimeout('update_last_played()', 3000)
    return false;
}
function update_playlist(url, not_notify) {
    $.get(url, function(data) {
        $("#playlist").html(data);
        if ($("#playlist .playing").length > 0) {
            play_selected();
        } else {
            var playing_id = $('#player').attr('playlist_id')
            $('#playlist #'+playing_id).addClass('playing');
            if($('#playlist .playing').length == 0) {
                player.pause();
            }
        }
        $('#playlist a.to_playlist').click(link_to_playlist);
        $('#playlist a.to_player').click(link_to_player);
        if (!not_notify) {
            ws.send(JSON.stringify({
                action: "update_playlist",
                key: "{{ user.id }}",
                playlist: playlist
            }));
        }
    });
}
function link_to_playlist() {
    var url = $(this).attr('href');
    update_playlist(url)
    return false;
}

function link_to_content() {
    var href = $(this).attr('href');
    $.get(href, function(data) {
        $("#content").html(data);
        $('#content a').click(link_to_content);
        $('#content a.to_playlist').unbind('click').click(link_to_playlist);
    });
    return false;
}

function update_last_played() {
    $.get('/last_played/', function(data) {
        $('#last_played').html(data);
        $('#meta a.to_content').click(link_to_content);
    });
}

function append_results(div, name, title, data) {
    div.append('<h4>' + title + '</h4>');
    div.append('<ul class="' + name + '" />');
    $(data).each(function(id, item) {
        if (name == 'artists') {
            var display = item['name'];
        } else {
            var display = item['artist'] + ' - ' + item['title'];
        }
        var link = $("<a href='"+ item['url'] +"'>" + display + "</a>");
        link.click(link_to_content);
        div.find('ul.' + name).append($("<li>").append(link));
    });

}

function search(term) {
    if (term.length > 2) {
        $.getJSON('{% url 'search' %}', {'q': term}, function(data) {
            $('#meta #search_results').remove();
            $('#meta').append('<div id="search_results" class="meta_overlay" />');
            var results = $('#meta #search_results');
            results.append('<h3 class="glyphicon glyphicon-search">Results</h3>');

            append_results(results, 'artists', 'Artists', data['artists']);
            append_results(results, 'albums', 'Albums', data['albums']);
            append_results(results, 'tracks', 'Tracks', data['tracks']);
        });
    } else {
        $('#meta #search_results').remove();
    }
}

function search_delay() {
	term = this.value;
	delay(function() {
		search(term);
	}, 300);
}

function change_players() {
    control_player = $(this).val();
    if (control_player == local_player) {
        $('#player').css('display', 'inline-block');
        $('#client-control').hide();
    } else {
        $('#player').hide();
        $('#client-control').css('display', 'inline-block');
    }
}

$(document).ready(function() {
    $('#artists-list a, #navigation a.external, a.to_content').click(link_to_content);
    $('#playlist a.to_player').click(link_to_player);
    $('#playlist a.to_playlist').click(link_to_playlist);
    $('#player').bind('ended', play_next);
    $('#searchbox').bind('keyup', search_delay);
    $('#players').bind('change', change_players);
    $("#players").append('<option value="' + player + '">' + control_player + '</option>');
    setInterval(update_last_played, 30000);
    update_last_played();

    ws = new WebSocket('{{ ws_url }}');

    ws.onmessage = function(message) {
        var obj = JSON.parse(message.data);

        if (obj['action'] == 'players') {
            $("#players").empty();
            $.each(obj['players'], function(index, item) {
                var selected = '';
                if (item['player'] == control_player) {
                    selected = 'selected';
                }

                var name = item['name']
                if (item['player'] == local_player) {
                    name = name + " (this)";
                } else {
                    name = name + " ("+item['player']+")";
                }
                $("#players").append('<option '+ selected +' value="' + item['player'] + '">' + name + '</option>');
            });
        } else if(obj['action'] == 'update_playlist') {
            if (obj['playlist'] == playlist) {
                update_playlist("{% url 'playlist' %}", true);
            }
        } else if(obj['action'] == 'song_change') {
            if (obj['playlist'] == playlist && obj['player'] == control_player) {
                $('#playlist tr').removeClass('playing');
                $('#playlist #' + obj['identifier']).addClass('playing');
            }
        } else if(obj['action'] == 'pause') {
            if (obj['player'] == control_player) {
                var player = $('#player').get(0);
                if (player.paused) {
                    player.play();
                } else {
                    player.pause();
                }
            }
        } else if(obj['action'] == 'next') {
            if (obj['player'] == control_player) {
                play_next();
            }
        } else if(obj['action'] == 'play_song') {
            if (obj['playlist'] == playlist && obj['player'] == control_player) {
                $('#playlist tr').removeClass('playing');
                $('#playlist #' + obj['identifier']).addClass('playing');
                play_selected();
            }
        } else {
            console.log(obj);
        }

    }
    ws.onopen = function() {
        ws.send(JSON.stringify({
            action: "register",
            key: "{{ user.id }}",
            player: local_player,
            playlist: playlist,
            name: 'Browser'
        }));
    }

    // client control
    $("#client_pause").click(function() {
        ws.send(JSON.stringify({
            action: "pause",
            key: "{{ user.id }}",
            player: control_player,
        }));

    });
    $("#client_next").click(function() {
        ws.send(JSON.stringify({
            action: "next",
            key: "{{ user.id }}",
            player: control_player,
        }));
    });
});

</script>


</head>

<body>

{% block all %}
<div id="outer-container">
    <div id="header">
        <div id="header_left">
            <h1><i class="glyphicon glyphicon-music"></i>Menosic</h1>
        </div>
        <div id="header_right">
            <a class="to_content" href="{% url "settings:detail" %}"><i class="glyphicon glyphicon-wrench"></i></a>
            <label for="seachbox" class="glyphicon glyphicon-search"></label>
            <input id="searchbox" name="search" type="text" />
        </div>
    </div>
    <div id="outer-content-container" class="container-fluid">
        <div class="row">
            <div class="col-sm-3 col-md-3" id="artists" data-spy="scroll" data-target="#navigation">
                <div id="navigation" class="affix">
                  <ul class="nav">
                    <li class="bottom-buffer"><a class="external" href="{% url "random_album" %}"><i class="glyphicon glyphicon-random"></i></a></li>
                    <li class="bottom-buffer"><a class="external" href="{% url "new_albums" %}"><i class="glyphicon glyphicon-plus"></i></a></li>
                  {% for letter in letters %}
                    <li><a href="#{{ letter }}">{{ letter }}</a></li>
                  {% endfor %}
                  </ul>
                </div>
                <div id="artists-list">
                  <h2>Artists</h2>
                  <ul class="nav nav-sidebar">
                    {% for artist in artists %}
                    {% ifchanged artist.sortkeyname.0 %}
                        </ul>
                        <span id="{{ artist.sortkeyname.0 }}">{{ artist.sortkeyname.0 }}</span>
                        <ul>
                    {% endifchanged %}

                    <li><a href="{{ artist.url }}">{{ artist.name }}</a></li>
                    {% endfor %}
                  </ul>
                </div>
            </div>

            <div class="col-sm-6 col-md-6" id="content-container">
                <div id="content" class="padding">
                        <h1>Welkom</h1>
                        <p>Please select a track</p>
                </div>
                <div id="playlist-container">
                    <div id="player-container">
                        <div id="player-selector">
                            <label for="players">Play on:</label>
                            <select id="players"></select>
                        </div>
                        <audio controls id="player">
                            <source id="mp3" type="audio/mpeg" />
                            <source id="ogg" type="audio/ogg" />
                            Your browser does not support the audio tag!
                        </audio>
                        <div id="client-control">
                            <i id="client_pause" class="glyphicon glyphicon-pause"></i>
                            <i id="client_next" class="glyphicon glyphicon-fast-forward"></i>
                        </div>
                    </div>
                    <div id="playlist" class="padding">
                        {% include 'music/playlist.html' %}
                    </div>
                </div>
            </div>
            <div class="col-sm-3 col-md-3 padding" id="meta">
                <h2>Meta</h2>
                <div id="last_played">
                </div>
            </div>

        </div>
    </div>
<div>
{% endblock all %}

</body>
</html>
